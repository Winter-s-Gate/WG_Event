<html lang="fr">
	<head>
		<meta charset="UTF-8">
		<title>Ajouter un Ã©vÃ©nement RP</title>
		<style>
			body {
				font-family: sans-serif;
				padding: 1.2em;
				background: #ffffff;
			}
			form {
				background: white;
				font-size: 1.2em;
				padding: 1em;
				border-radius: 8px;
				max-width: 400px;
				margin: auto;
			}
			label {
				font-size: 1.2em;
				display: block;
				margin-top: 1em;
			}
			input,
			button {
				font-size: 1.2em;
				width: 100%;
				padding: 0.5em;
				margin-top: 0.5em;
			}
			button {
				background: #4CAF50;
				color: white;
				border: none;
				cursor: pointer;
			}
			#confirmation {
				margin-top: 1em;
				text-align: center;
				font-weight: bold;
			}
		</style>
	</head>
	<body>
		<form id="eventForm">
			<h2>â• Add event</h2>
			<label>ğŸ•’ Hours:</label>
				<input type="time" name="time" required />

			<label>ğŸ“… Date:</label>
				<input type="date" name="date" required />

			<label>ğŸ­ Title:</label>
				<input type="text" name="title" required />

			<label>ğŸ‘¤ Host:</label>
				<input type="text" name="host" required />

			<label>ğŸ“ Location:</label>
				<input type="text" name="location" required />

			<label>ğŸ” Weekly:</label>
				<input type="checkbox" name="repeat" />

			<button type="submit">ğŸ“¤ Send</button>
			<button type="button" onclick="cancelForm()">âŒ Cancel</button>
		</form>

		<div id="confirmation"></div>

		<script>
		// ğŸ” Capture et stocke lâ€™UUID dÃ¨s le chargement initial
			let uuid = null;
			(function () {
				const urlUUID = new URLSearchParams(window.location.search).get("uuid");
				if (urlUUID) {
					localStorage.setItem("wg_uuid", urlUUID);
					uuid = urlUUID;
					const cleanURL = window.location.origin + window.location.pathname;
					window.history.replaceState({}, document.title, cleanURL);
				} else {
					uuid = localStorage.getItem("wg_uuid");
				}
			})();

			document.getElementById("eventForm").addEventListener("submit", function (e) {
				e.preventDefault();
				const form = e.target;
				const formData = new FormData(form);
	
				// ğŸ” Normalise la checkbox repeat
				formData.set("repeat", form.repeat.checked ? "true" : "false");

				// ğŸ” Injecte lâ€™UUID stockÃ©
				if (uuid) formData.set("uuid", uuid);

				const body = new URLSearchParams(formData).toString();

				fetch("https://wgevent.wintersgatesl.workers.dev/", {
					method: "POST",
					headers: {
						"Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
					},
					body: body
				})
				.then(res => {
					if (!res.ok) throw new Error("response not ok");
					return res.text();
				})
				.then(msg => {
					document.getElementById("confirmation").textContent = msg;
					console.log("RÃ©ponse serveur:", msg);
					setTimeout(() => {
						window.location.href = `index.html?uuid=${uuid}`;
					}, 1500); // â³ Attente avant redirection
				})
				.catch(err => {
					console.error("Erreur de soumission :", err);
					document.getElementById("confirmation").textContent = "âŒ Erreur rÃ©seau ou script.";
				});
			});

			function cancelForm() {
				window.location.href = `index.html?uuid=${uuid}`;
			}
		</script>
	</body>
</html>
